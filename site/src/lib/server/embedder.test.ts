import { describe, it, expect, beforeEach } from "vitest"
import Embedder from "./embedder"

const QUERY = "A query"
const EMBEDDING = [
	0.05054321, 0.08753632, 0.01181693, 0.0924169, -0.11664072, 0.08489928,
	0.20307507, 0.02345099, 0.05914285, -0.03726233, 0.04234764, -0.07766031,
	0.07483907, -0.06975456, -0.06141472, 0.0107212, -0.00631666, 0.00008489,
	-0.04850366, -0.02448913, -0.07166312, 0.0323763, -0.05660433, 0.05967346,
	-0.00491682, 0.02636682, 0.03947349, 0.00219054, 0.0510271, -0.06409984,
	-0.11115279, 0.04513286, 0.05088874, 0.07109983, 0.03121062, -0.09755543,
	0.00977165, -0.01742846, 0.01280328, -0.03372893, -0.00704776, -0.10403176,
	0.0449085, -0.00261259, -0.0535019, 0.04382598, -0.0736671, 0.07503545,
	0.00620655, -0.00009332, -0.14951342, 0.01803298, -0.09919384, -0.03584458,
	0.03665516, -0.02063475, -0.10558549, -0.00384718, -0.0240849, 0.04064505,
	0.02882623, -0.00937345, 0.03957942, 0.05062236, 0.04237209, -0.07894136,
	-0.0007584, -0.01463766, 0.03061204, -0.05534746, 0.0083024, 0.0065542,
	-0.02791281, 0.04908993, 0.00571814, -0.01453052, -0.03218531, -0.03651434,
	0.084941, 0.00015889, -0.03826058, -0.03079541, -0.06459332, 0.05125116,
	0.08890783, -0.05884281, 0.07197912, -0.03988582, 0.05255217, -0.02596478,
	-0.07233217, 0.01498612, 0.01290671, 0.00110089, -0.02164803, 0.00126735,
	0.05142777, -0.04306163, 0.08020269, 0.18643574, 0.02204936, 0.05074609,
	-0.0611025, -0.04714375, -0.1313585, 0.00014144, -0.02930722, -0.02170211,
	0.02507905, -0.02576924, -0.0704788, -0.03456713, 0.01998273, -0.01118894,
	0.01244437, -0.04880349, 0.03971476, 0.02300097, -0.0079801, -0.05029897,
	0.07551133, 0.07076966, -0.02684166, -0.02954226, -0.0297657, -0.03985627,
	0.04000012, -0, 0.0002395, -0.02614421, 0.03007001, -0.00773782, -0.03344793,
	0.02588529, -0.03846274, 0.02645906, -0.02519665, 0.03807543, -0.04273837,
	0.01822992, 0.04164686, 0.00073425, 0.05825814, 0.00358049, 0.08238767,
	0.01775127, -0.03817334, -0.0098718, -0.05650213, -0.00812451, 0.02498494,
	0.09925406, 0.07197107, -0.04868571, -0.03036962, -0.03305117, 0.01849022,
	0.02161507, 0.0106097, 0.005424, -0.08184674, -0.09813104, 0.03808675,
	-0.02537763, 0.04516659, -0.0231027, 0.05542072, 0.03000946, -0.02916003,
	-0.01419204, 0.07478682, -0.0674831, -0.02599081, -0.01012482, 0.01512692,
	-0.00899499, -0.00973564, 0.02609356, -0.03607436, -0.03936121, -0.05487662,
	-0.01158877, 0.07094336, -0.01157335, -0.02891777, 0.10089315, 0.00367521,
	0.08553633, -0.00104086, -0.02372462, -0.0145426, -0.03548701, 0.0010311,
	-0.01435618, 0.01495237, -0.01909852, 0.11766394, -0.00369035, -0.00247775,
	-0.03765444, 0.05402388, -0.04018368, -0.05650981, 0.01253284, 0.02299787,
	0.04155806, -0.0248692, 0.02900449, -0.07346051, -0.08373, 0.0108534,
	0.02376123, -0.01284201, 0.03730709, 0.01527971, -0.02481559, 0.03291215,
	-0.01859364, -0.05829273, 0.00623617, 0.00582214, 0.02408341, 0.04867736, 0,
	-0.04427868, 0.0038912, -0.05460264, -0.00961161, 0.03188386, -0.09229796,
	0.03375407, -0.08687094, -0.06222831, 0.04697923, 0.01729965, -0.02143639,
	0.09505314, -0.06408648, 0.05484736, 0.08944803, 0.0834771, -0.04430406,
	-0.05704765, 0.07192905, -0.08405899, 0.01968854, -0.01887986, -0.00199402,
	-0.01225348, 0.03485863, 0.00229561, -0.01021482, -0.04652626, 0.01286695,
	0.0360334, -0.15779184, 0.01435963, 0.0034248, -0.04093368, -0.03155335,
	0.04290437, -0.01079412, -0.02909305, 0.06441112, 0.07285468, -0.00356574,
	0.0922033, 0.16539584, 0.00895427, -0.0036395, -0.05133159, 0.00194486,
	0.04512583, 0.01439654, -0.02757842, 0.02683472, 0.00612153, -0.01467906,
	-0.01837217, 0.01621958, -0.06896997, 0.00526422, 0.05641009, 0.01140082,
	-0.00192941, 0.10614146, -0.03041417, 0.05620529, -0.01153868, -0.01602485,
	-0.05683718, -0.0212143, -0.04433874, 0.04033067, 0.03738192, 0.00965184,
	0.00757688, -0.02239783, -0.03581662, 0.02600826, -0.0849516, 0.03138389,
	-0.02784669, 0.02565247, -0.07804587, 0.04535208, 0.03743117, 0.03363191,
	-0.04426587, -0.01308811, 0.0515325, -0.00493195, -0.00489749, 0.00152292,
	0.05919857, -0.01428197, -0.07001074, -0.10518949, 0.01733169, -1e-8,
	-0.04464317, -0.0537491, -0.06221056, 0.00830721, 0.16003603, 0.0200289,
	-0.00968874, 0.07231126, -0.06464694, 0.0426914, 0.06441915, -0.02241082,
	0.01944458, 0.03259151, 0.02426455, -0.02622276, -0.09092531, 0.01472578,
	-0.04467519, -0.09910009, -0.02511241, -0.01297374, 0.00181265, 0.02131472,
	-0.02748636, 0.03480763, -0.03780264, -0.02806823, 0.04970277, 0.05835292,
	-0.01583652, 0.03770531, 0.06492928, -0.02680096, 0.05912075, -0.07899482,
	0.01017668, -0.03566853, -0.04673418, -0.07188498, 0.01808451, -0.01026084,
	-0.0286985, 0.0491627, -0.01552881, -0.12161748, 0.04470666, -0.04052411,
	0.01047114, -0.03214956, -0.00640763, -0.04838043, 0.08930206, 0.00086709,
	-0.06985641, 0.02665898, 0.03385398, 0.00779161, -0.06420945, -0.04405459,
	0.01720666, 0.01417437, -0.01112673, 0.09099089,
]

describe("Embedder", () => {
	let embedder: Embedder
	beforeEach(() => {
		embedder = Embedder()
	})

	it("returns embeddings", async () => {
		const result = await embedder.embed(QUERY)

		expect(result).toStrictEqual(EMBEDDING)
	})

	it("supports simultaneous queries", async () => {
		const simultaneousQuery = "Simultaenous query"

		const promise1 = embedder.embed(QUERY)
		const promise2 = embedder.embed(simultaneousQuery)
		const result2 = await promise2
		const result1 = await promise1

		expect(result1).toStrictEqual(EMBEDDING)
		expect(result2).toStrictEqual([
			0.07303183, 0.03543139, -0.04289626, 0.0402833, -0.12921081, 0.01033619,
			0.11983178, 0.03024135, 0.01676476, -0.00461643, 0.04991936, -0.07464373,
			0.06132552, -0.05389897, -0.01195217, -0.01440865, -0.00204561,
			0.01400175, -0.04715182, -0.08079594, 0.02904821, -0.01486828,
			-0.05328179, -0.01767941, 0.00691821, -0.0078529, -0.01127743,
			-0.05285513, 0.1002246, -0.00276684, -0.06039915, 0.07445714, -0.03675729,
			0.05015801, 0.05555733, -0.10392982, -0.02832233, -0.06030904, 0.05717026,
			0.00564765, -0.03692348, -0.05751042, 0.00775363, -0.00022756,
			-0.00758085, 0.06658519, -0.08423016, 0.07798444, -0.01482229,
			-0.00918095, -0.16703585, -0.00407256, -0.0878361, 0.00642186, 0.08515532,
			0.00125839, -0.09849449, -0.01290561, -0.04710376, 0.02444007,
			-0.00437669, 0.00155313, -0.01634375, 0.00252417, 0.00691386, -0.05149257,
			0.00719292, 0.02983916, 0.10493974, -0.04461646, 0.05378063, 0.01907944,
			-0.03922572, 0.05446729, -0.04130213, 0.10911757, -0.00608631,
			-0.02697863, 0.04057984, 0.00263728, -0.01764379, -0.03622589,
			-0.07162289, -0.00550186, 0.0615276, -0.03674276, -0.02108164,
			-0.00975991, 0.06380107, 0.00474304, 0.00862567, 0.02490947, 0.00232964,
			-0.01080856, -0.02084188, -0.00923648, 0.06406505, -0.03835198,
			0.05835609, 0.12691145, -0.00006308, 0.02953316, -0.02904969, -0.07000529,
			-0.17946403, -0.00146831, -0.01314173, -0.05280935, 0.02787223,
			-0.04586117, -0.0875787, 0.0469228, 0.06538325, -0.05257907, -0.04058826,
			-0.00626277, -0.00773714, 0.02221688, 0.09629788, -0.0656376, 0.0480371,
			0.07603325, -0.05990609, 0.00354139, 0.02838722, -0.06830055, 0.07456024,
			0, 0.00774967, -0.00455398, 0.06592289, -0.00651584, -0.02446755,
			0.04522482, -0.00950984, 0.0059936, -0.01696303, 0.0809362, -0.02867188,
			0.02088224, 0.02602639, 0.03341755, -0.01875054, 0.00219258, 0.06756726,
			-0.00637355, -0.0552387, 0.04221202, -0.01692019, 0.01382672, -0.00228412,
			0.06193575, 0.02487383, 0.00352898, -0.04420472, -0.02683572, 0.02114159,
			0.04513275, -0.01522629, -0.00642571, -0.14033101, -0.07321084,
			0.03043524, 0.0434791, 0.07653604, -0.03934487, -0.04177517, 0.03871632,
			-0.04360498, 0.00178476, 0.06938092, 0.00897854, -0.02845658, -0.04552737,
			-0.04123374, -0.02408913, 0.07996548, 0.01261022, -0.04248014,
			-0.00696583, 0.03318535, -0.04199371, 0.09856236, -0.00445381, -0.0012076,
			0.10386572, -0.01456521, 0.10139488, -0.03711439, -0.07105535,
			-0.03032351, -0.04438416, 0.02391085, 0.02931155, -0.09271954, -0.0990909,
			0.08920635, 0.05293788, 0.01449924, 0.02394193, 0.02460632, -0.03435259,
			0.00356349, 0.0225042, 0.01542447, 0.05381238, 0.04838932, -0.03531823,
			-0.00174799, -0.02564387, -0.01841507, 0.05067271, -0.01557376,
			0.04258733, 0.05241257, -0.01098402, 0.02337095, -0.00958192, -0.03338832,
			-0.02035501, 0.01642155, -0.00455071, 0.03735923, -0, -0.07197347,
			0.02798566, -0.05225342, -0.03425077, -0.00753482, -0.0423445, 0.05291591,
			-0.06496769, -0.06842992, -0.05809871, -0.01823853, -0.05014483,
			0.04740224, -0.04610647, 0.05499559, 0.10966568, 0.06015566, -0.07439736,
			-0.04501113, 0.09730718, -0.07527091, 0.04256046, -0.07697567,
			-0.03650971, 0.04405419, -0.01525719, -0.01271943, -0.0263935, -0.0584315,
			-0.02188517, 0.04002136, -0.1423121, 0.0250715, -0.00280582, -0.04642003,
			-0.04500132, 0.08673997, 0.03387813, -0.01938925, 0.01334879, 0.00813216,
			-0.02705214, 0.08816016, 0.12258577, 0.00245515, 0.00072732, -0.10203881,
			-0.02624601, 0.06198261, 0.01785996, 0.01073486, 0.04325519, -0.02606129,
			-0.03158667, 0.08564624, -0.03637222, -0.11554185, -0.01127816,
			0.00475341, -0.00865741, -0.00145808, 0.07061759, -0.0417659, 0.00651614,
			0.07591914, -0.04406681, -0.08102129, -0.05413578, -0.08409204,
			-0.05731267, 0.01093074, -0.03214261, -0.02885021, -0.07323102,
			-0.03691082, 0.00794916, -0.05831084, 0.07717024, -0.00696705, 0.04442139,
			-0.02523066, 0.02950759, 0.06391842, 0.0232798, -0.04559999, -0.00177574,
			0.08223121, -0.02465235, 0.03902328, -0.00626628, -0.03321943,
			-0.01125144, -0.01225545, -0.04522509, 0.05380898, -2e-8, -0.06963476,
			0.00153888, -0.03550377, 0.04312204, 0.11406977, 0.0303492, -0.00152716,
			0.13309096, -0.05572801, -0.01735224, 0.01318568, -0.05555898, 0.04709174,
			-0.00030147, 0.06612124, -0.02221775, 0.00454481, -0.02386645,
			-0.03623437, -0.02055039, -0.01161435, 0.01967958, -0.01855926,
			-0.0478722, -0.02392434, 0.08018352, 0.01132958, -0.00043053, 0.05367592,
			0.07483636, -0.01443794, 0.00793406, 0.07200896, -0.01673788, -0.00190867,
			-0.08635509, -0.01465118, 0.01999859, -0.0216285, -0.10198512, 0.01136213,
			-0.02099249, -0.00217239, 0.10722119, 0.06382819, -0.05981932, 0.07941265,
			-0.0517936, 0.05260855, -0.02682362, -0.0471129, -0.09555004, 0.01985948,
			-0.02397371, -0.054784, 0.00765328, 0.04902022, 0.04977148, -0.04637315,
			-0.00977735, 0.0157374, 0.02057493, -0.03846942, 0.03557356,
		])
	})
})
